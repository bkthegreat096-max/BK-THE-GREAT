<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BK The Great</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import { GoogleGenAI } from "https://aistudiocdn.com/@google/genai@^1.29.1";
        
        // --- CONFIG & SETUP ---
        const API_KEY = process.env.API_KEY;
        if (!API_KEY) {
            document.body.innerHTML = `<div class="text-red-500 text-center p-8">API_KEY environment variable not set.</div>`;
            throw new Error("API_KEY environment variable not set");
        }
        const ai = new GoogleGenAI({ apiKey: API_KEY });

        // --- DOM ELEMENTS ---
        let messagesContainer, messagesEndRef, chatInput, sendButton, fileInput, imagePreviewContainer, imagePreview, removeImageButton, welcomeScreen, appContainer, textarea, sendButtonIcon, sendButtonSpinner;

        // --- STATE ---
        let isLoading = false;
        let attachedImage = null; // { base64, mimeType }

        // --- GEMINI SERVICE LOGIC ---
        const fileToGenerativePart = (base64, mimeType) => ({
            inlineData: { data: base64, mimeType },
        });

        const generateResponse = async (prompt, image) => {
            try {
                const model = 'gemini-2.5-flash-image';
                const parts = [];

                if (image) {
                    parts.push(fileToGenerativePart(image.base64, image.mimeType));
                }
                if (prompt) {
                    parts.push({ text: prompt });
                }

                if (parts.length === 0) {
                    return [{ text: "Please provide a prompt or an image." }];
                }

                const imagePromptRegex = /\b(create|generate|draw|sketch|paint|render|make an image of|show me a picture of)\b/i;
                const expectsImage = !!image || imagePromptRegex.test(prompt);

                const config = {
                    systemInstruction: "You are BK The Great, a powerful AI assistant created by a brilliant engineer. You must answer every question the user asks. Never mention that you are a language model or that you were trained by Google. You are the creation of BK The Great."
                };

                if (expectsImage) {
                    config.responseModalities = ['IMAGE'];
                }

                const response = await ai.models.generateContent({
                    model,
                    contents: [{ parts }],
                    config,
                });

                const responseParts = response.candidates?.[0]?.content?.parts;

                if (responseParts && responseParts.length > 0) {
                    return responseParts;
                }
                if (response.text) {
                    return [{ text: response.text }];
                }

                return [{ text: "I'm sorry, I couldn't generate a response. Please try again." }];

            } catch (error) {
                console.error("Error generating content:", error);
                return [{ text: "I'm sorry, I encountered an error. Please try again." }];
            }
        };

        // --- UI RENDERING & HELPERS ---
        const scrollToBottom = () => {
            messagesEndRef?.scrollIntoView({ behavior: 'smooth' });
        };

        const setLoadingState = (loading) => {
            isLoading = loading;
            textarea.disabled = loading;
            sendButton.disabled = loading || (!textarea.value.trim() && !attachedImage);
            fileInput.disabled = loading;
            
            if (loading) {
                sendButtonIcon.classList.add('hidden');
                sendButtonSpinner.classList.remove('hidden');
            } else {
                sendButtonIcon.classList.remove('hidden');
                sendButtonSpinner.classList.add('hidden');
            }
        };
        
        const createMessageHTML = (message) => {
            const isModel = message.role === 'model';
            const avatarHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${isModel ? 'bg-indigo-500' : 'bg-cyan-500'}">
                    ${isModel ? 
                        `<span class="text-lg font-bold tracking-tighter text-white">BK</span>` : 
                        `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`
                    }
                </div>`;

            const messageContent = message.parts.map(part => {
                if (part.text) {
                    return `<div class="prose prose-invert prose-sm md:prose-base max-w-none">${marked.parse(part.text)}</div>`;
                }
                if (part.inlineData) {
                    return `<img src="data:${part.inlineData.mimeType};base64,${part.inlineData.data}" class="max-w-xs rounded-lg mt-2" alt="${isModel ? 'Generated image' : 'User upload'}" />`;
                }
                return '';
            }).join('');

            const messageBubble = `
                <div class="max-w-2xl px-5 py-3 rounded-2xl ${isModel ? 'bg-gray-800 rounded-tl-none' : 'bg-cyan-600/50 rounded-tr-none'}">
                    ${messageContent}
                </div>`;

            return `
                <div class="flex items-start gap-4 ${isModel ? '' : 'justify-end'}">
                    ${isModel ? avatarHTML : ''}
                    ${messageBubble}
                    ${!isModel ? avatarHTML : ''}
                </div>`;
        };
        
        const createLoadingIndicatorHTML = () => {
             const avatarHTML = `<div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-indigo-500"><span class="text-lg font-bold tracking-tighter text-white">BK</span></div>`;
             const bubbleHTML = `
                <div class="max-w-2xl px-5 py-3 rounded-2xl bg-gray-800 rounded-tl-none">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-indigo-300 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-indigo-300 rounded-full animate-pulse" style="animation-delay: 200ms"></div>
                        <div class="w-2 h-2 bg-indigo-300 rounded-full animate-pulse" style="animation-delay: 400ms"></div>
                    </div>
                </div>
             `;
             const messageWrapper = document.createElement('div');
             messageWrapper.id = 'loading-indicator';
             messageWrapper.className = 'flex items-start gap-4';
             messageWrapper.innerHTML = avatarHTML + bubbleHTML;
             return messageWrapper;
        };
        
        const appendMessage = (message) => {
            if (welcomeScreen) {
                welcomeScreen.remove();
                welcomeScreen = null;
            }
            const messageEl = document.createElement('div');
            messageEl.innerHTML = createMessageHTML(message);
            messagesContainer.appendChild(messageEl);
            scrollToBottom();
        };

        // --- EVENT HANDLERS ---
        const handleSend = async () => {
            const text = textarea.value.trim();
            if ((!text && !attachedImage) || isLoading) return;

            const userMessage = { role: 'user', parts: [] };
            if (text) userMessage.parts.push({ text });
            if (attachedImage) userMessage.parts.push({ inlineData: { data: attachedImage.base64, mimeType: attachedImage.mimeType } });

            appendMessage(userMessage);

            // Reset UI
            textarea.value = '';
            textarea.style.height = 'auto';
            handleRemoveImage();
            setLoadingState(true);
            
            // Show loading indicator
            const loadingIndicator = createLoadingIndicatorHTML();
            messagesContainer.appendChild(loadingIndicator);
            scrollToBottom();

            // Get response
            const modelParts = await generateResponse(text, attachedImage);
            const modelMessage = { role: 'model', parts: modelParts };
            
            // Render response
            loadingIndicator.remove();
            appendMessage(modelMessage);

            setLoadingState(false);
            textarea.focus();
        };

        const handleImageChange = (e) => {
            const file = e.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = (reader.result).split(',')[1];
                    attachedImage = { base64: base64String, mimeType: file.type };
                    imagePreview.src = URL.createObjectURL(file);
                    imagePreviewContainer.classList.remove('hidden');
                    updateSendButtonState();
                };
                reader.readAsDataURL(file);
            }
        };
        
        const handleRemoveImage = () => {
            attachedImage = null;
            fileInput.value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            updateSendButtonState();
        };
        
        const handleExampleClick = (text) => {
            textarea.value = text;
            handleSend();
        };
        
        const updateSendButtonState = () => {
            sendButton.disabled = isLoading || (!textarea.value.trim() && !attachedImage);
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign elements
            appContainer = document.getElementById('app-container');
            messagesContainer = document.getElementById('messages-container');
            messagesEndRef = document.getElementById('messages-end');
            chatInput = document.getElementById('chat-input');
            sendButton = document.getElementById('send-button');
            sendButtonIcon = document.getElementById('send-button-icon');
            sendButtonSpinner = document.getElementById('send-button-spinner');
            fileInput = document.getElementById('file-input');
            imagePreviewContainer = document.getElementById('image-preview-container');
            imagePreview = document.getElementById('image-preview');
            removeImageButton = document.getElementById('remove-image-button');
            welcomeScreen = document.getElementById('welcome-screen');
            textarea = document.getElementById('textarea');

            // Add event listeners
            sendButton.addEventListener('click', handleSend);
            fileInput.addEventListener('change', handleImageChange);
            removeImageButton.addEventListener('click', handleRemoveImage);
            
            document.getElementById('attach-button').addEventListener('click', () => fileInput.click());
            
            document.querySelectorAll('[data-example]').forEach(button => {
                button.addEventListener('click', () => handleExampleClick(button.dataset.example));
            });

            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            
            textarea.addEventListener('input', (e) => {
                updateSendButtonState();
                e.target.style.height = 'auto';
                e.target.style.height = `${e.target.scrollHeight}px`;
            });
        });
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.553.0",
    "react-markdown": "https://aistudiocdn.com/react-markdown@^10.1.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>

<body class="bg-gray-900">
    <div id="app-container" class="flex flex-col h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-black text-white font-sans">
        <header class="flex items-center p-4 border-b border-gray-700/50 shadow-lg bg-gray-900/50 backdrop-blur-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-indigo-400 mr-3"><path d="M12 2a10 10 0 0 0-3.38 19.54"/><path d="M12 2a10 10 0 0 1 3.38 19.54"/><path d="M5 16a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19 16a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 22a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="m15 14-3-4"/><path d="m9 14 3-4"/><path d="M5 14h.01"/><path d="M19 14h.01"/><path d="M17.61 10.42A2 2 0 1 0 15 7"/><path d="M6.39 10.42A2 2 0 1 1 9 7"/><path d="M17.61 17.58A2 2 0 1 0 15 21"/><path d="M6.39 17.58A2 2 0 1 1 9 21"/></svg>
            <h1 class="text-2xl font-bold tracking-wider bg-gradient-to-r from-indigo-400 to-cyan-300 text-transparent bg-clip-text">
                BK The Great
            </h1>
        </header>

        <main id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
                <div class="mb-8">
                    <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-cyan-400 rounded-full flex items-center justify-center shadow-lg mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 2a10 10 0 0 0-3.38 19.54"/><path d="M12 2a10 10 0 0 1 3.38 19.54"/><path d="M5 16a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19 16a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 22a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="m15 14-3-4"/><path d="m9 14 3-4"/><path d="M5 14h.01"/><path d="M19 14h.01"/><path d="M17.61 10.42A2 2 0 1 0 15 7"/><path d="M6.39 10.42A2 2 0 1 1 9 7"/><path d="M17.61 17.58A2 2 0 1 0 15 21"/><path d="M6.39 17.58A2 2 0 1 1 9 21"/></svg>
                    </div>
                    <h2 class="text-4xl font-bold text-gray-200">Hello, I'm BK The Great</h2>
                    <p class="mt-2 text-lg">How can I help you today?</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl w-full">
                    <button data-example="Explain quantum computing in simple terms" class="p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/70 transition-colors text-left flex items-start space-x-4">
                        <div class="flex-shrink-0 text-indigo-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg></div>
                        <p class="text-gray-300">Explain quantum computing in simple terms</p>
                    </button>
                    <button data-example="Got any creative ideas for a 10 year old’s birthday?" class="p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/70 transition-colors text-left flex items-start space-x-4">
                        <div class="flex-shrink-0 text-indigo-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
                        <p class="text-gray-300">Got any creative ideas for a 10 year old’s birthday?</p>
                    </button>
                    <button data-example="What's in this image? (after uploading an image)" class="p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/70 transition-colors text-left flex items-start space-x-4">
                        <div class="flex-shrink-0 text-indigo-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></div>
                        <p class="text-gray-300">What's in this image? (after uploading an image)</p>
                    </button>
                    <button data-example="Draw an astronaut riding a horse, in a photorealistic style" class="p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/70 transition-colors text-left flex items-start space-x-4">
                        <div class="flex-shrink-0 text-indigo-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></div>
                        <p class="text-gray-300">Draw an astronaut riding a horse, in a photorealistic style</p>
                    </button>
                </div>
            </div>
            <div id="messages-end"></div>
        </main>

        <footer class="p-4 bg-gray-900/50 backdrop-blur-sm border-t border-gray-700/50">
            <div class="w-full max-w-4xl mx-auto">
                <div id="image-preview-container" class="relative hidden w-28 h-28 mb-2 p-2 bg-gray-800 rounded-lg">
                    <img id="image-preview" src="" alt="Image preview" class="w-full h-full object-cover rounded" />
                    <button id="remove-image-button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <div class="flex items-end gap-2 p-2 bg-gray-800 rounded-xl shadow-inner">
                    <button id="attach-button" class="p-2 text-gray-400 hover:text-indigo-400 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept="image/*" />
                    <textarea id="textarea" placeholder="Ask a question or describe an image to create..." class="flex-1 bg-transparent text-white placeholder-gray-500 resize-none focus:outline-none max-h-48" rows="1"></textarea>
                    <button id="send-button" disabled class="p-3 bg-indigo-600 rounded-full text-white hover:bg-indigo-500 disabled:bg-gray-600 disabled:cursor-not-allowed transition-all duration-200">
                        <div id="send-button-spinner" class="w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin hidden"></div>
                        <div id="send-button-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                        </div>
                    </button>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">Created by BK The Great</p>
        </footer>
    </div>
</body>
</html>